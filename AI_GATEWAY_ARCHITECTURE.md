# AI Gateway - Centralized Architecture ğŸ¯

## System Overview

```mermaid
graph TB
    subgraph "Frontend Apps"
        A[ğŸ“± Mobile App]
        B[ğŸ–¥ï¸ Desktop Web]
        C[ğŸ‘¨â€ğŸ’¼ Admin Panel]
    end
    
    subgraph "AI Gateway Hub"
        D[ğŸ” unified_ai.py]
        E[ğŸ“Š Usage Tracking]
        F[ğŸ”„ Health Scoring]
    end
    
    subgraph "Text Generation Providers"
        G[ğŸ¤– Gemini]
        H[âš¡ OpenRouter]
        I[ğŸŒ HuggingFace]
    end
    
    subgraph "Image Generation Providers"
        J[ğŸ¨ Pollinations AI<br/>FREE - No Key!]
        K[ğŸ–¼ï¸ Gemini Image]
        L[ğŸ¯ HuggingFace SD]
    end
    
    A --> D
    B --> D
    C --> D
    
    D --> G
    D --> H
    D --> I
    
    D --> J
    D --> K
    D --> L
    
    D --> E
    D --> F
```

---

## Text Generation Flow

```mermaid
sequenceDiagram
    participant User
    participant Story Generator
    participant unified_ai
    participant Gateway Keys
    participant Gemini
    participant OpenRouter
    
    User->>Story Generator: Generate Story
    Story Generator->>unified_ai: generate_ai_content(user, prompt)
    
    unified_ai->>Gateway Keys: Get active keys by health score
    Gateway Keys-->>unified_ai: [Key1, Key2, Key3...]
    
    unified_ai->>Gemini: Try Key1 (gemini-2.5-flash)
    
    alt Success
        Gemini-->>unified_ai: âœ… Response
        unified_ai->>Gateway Keys: Update usage counter +1
        unified_ai-->>Story Generator: Story text
    else Quota Exceeded
        Gemini-->>unified_ai: âŒ 429 Error
        unified_ai->>OpenRouter: Try Key2 (mistral-7b)
        OpenRouter-->>unified_ai: âœ… Response
        unified_ai-->>Story Generator: Story text
    end
    
    Story Generator-->>User: Display Story
```

---

## Image Generation Flow

```mermaid
flowchart TD
    A[ğŸ–¼ï¸ Image Request] --> B{Pollinations.AI}
    
    B -->|âœ… Success| C[Return Image]
    B -->|âŒ Failed| D{Gemini Image}
    
    D -->|âœ… Success| C
    D -->|âŒ No Key/Failed| E{HuggingFace SD}
    
    E -->|âœ… Success| C
    E -->|âŒ Failed| F[Return Error]
    
    style B fill:#22c55e,color:#fff
    style C fill:#3b82f6,color:#fff
    style F fill:#ef4444,color:#fff
```

> **Key Point:** Pollinations.AI is **FREE with no API key required!**

---

## Provider Adapters

### Text Generation Adapters (6)
| File | Provider | Free Tier |
|------|----------|-----------|
| `gemini.py` | Google Gemini | âœ… 500/day |
| `openrouter.py` | OpenRouter | âœ… Varies |
| `huggingface.py` | HuggingFace | âœ… 1000/day |
| `groq.py` | Groq | âœ… Fast |
| `cohere.py` | Cohere | âœ… Limited |
| `deepinfra.py` | DeepInfra | âœ… Limited |

### Image Generation Adapters (4)
| File | Provider | Free Tier |
|------|----------|-----------|
| `image_pollinations.py` | Pollinations.AI | âœ… **UNLIMITED!** |
| `image_gemini.py` | Google Gemini | 500/day |
| `image_huggingface.py` | Stable Diffusion | 1000/day |
| `image_openrouter.py` | OpenRouter | Varies |

---

## Generated Test Image

![Generated owl reading a German book](file:///e:/vocab_web/server/test_generated_image.png)

*A friendly cartoon owl reading a German language book - generated by Pollinations.AI*

---

## API Entry Points

| Feature | Endpoint | Uses Gateway? |
|---------|----------|---------------|
| Story Generator | `generate-advanced-text/` | âœ… Yes |
| Exam Generator | `generate-exam/` | âœ… Yes |
| Text Converter | `convert-text/` | âœ… Yes |
| Vocab Enrichment | `vocab/` | âœ… Yes |
| **Image Generation** | `generate_ai_image()` | âœ… Yes |

---

## Code Usage Example

### Text Generation
```python
from api.unified_ai import generate_ai_content

response = generate_ai_content(
    user=request.user,
    prompt="Write a German story about a cat",
    max_tokens=2048
)
print(response.text)
```

### Image Generation
```python
from api.unified_ai import generate_ai_image

result = generate_ai_image(
    user=request.user,
    prompt="A colorful owl reading a book",
    size="1024x1024",
    style="cartoon"
)

if result["success"]:
    image_base64 = result["image_base64"]
```

---

## Summary Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR APP REQUESTS                          â”‚
â”‚         Stories â€¢ Exams â€¢ Text â€¢ Vocabulary â€¢ Images         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ¯ UNIFIED AI GATEWAY                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Key Selectorâ”‚  â”‚Usage Trackerâ”‚  â”‚Health Score â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                              â”‚
â”‚  Automatic Fallback: Provider 1 â†’ Provider 2 â†’ Provider 3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Gemini  â”‚          â”‚OpenRouterâ”‚         â”‚Pollinationsâ”‚
   â”‚  FREE   â”‚          â”‚  FREE   â”‚          â”‚   FREE    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*Document created: December 8, 2025*
